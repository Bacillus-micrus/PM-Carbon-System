---
title: "Carbon System of the Portugese Margin"
author: "Nils Lucas Jacobsen"
date: "`r format(Sys.time(), '%d %B, %Y')`"  # With Sys.Date it updates automatically
output: 
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 5
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = "center")
```

# PM trends step 0
```{r installing and loading packages}

# This step installs packages if needed
list.of.packages <- c("R.matlab", "rlist", "tidyverse", "readxl", "marmap", "seacarb", "xlsx", "reshape2", "readr", "lubridate")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

# Load packages
library(R.matlab)
library(rlist)
library(tidyverse)
library(readxl)
library(marmap)
library(seacarb)
library(xlsx)
library(reshape2)
library(readr)
library(lubridate)
```

# PM trends step 1
```{r Loading and filtering data & defining study area}

A <- readMat('GLODAPv2.2020_Atlantic_Ocean.mat')
# Keep the expocodes and their correspondence with G2cruise (expocodeno)
expocodes <- data.frame(); expocodes <- as.data.frame(unlist(A$expocode))
expocodes[, 2] <- as.data.frame(unlist(A$expocodeno))
names(expocodes) <- c("expocode", "expocodeno")
A <- A %>% list.remove(c("expocode", "expocodeno")) %>% as.data.frame()

ABasin <- data.frame(lon = c(-13, -7), lat = c(36, 42))  # Defining the geographical region

# Filter for geographical area, remove NAs in salinity and potential temperature, and add data soucre
A <- A %>%
  filter(G2latitude >= (min(ABasin$lat)) & G2latitude <= (max(ABasin$lat))) %>%
  filter(G2longitude >= (min(ABasin$lon)) & G2longitude <= (max(ABasin$lon))) %>%
  mutate_all(.funs = funs(ifelse(. == "NaN", NA, .))) %>%
  filter((!is.na(G2salinity))) %>%
  filter((!is.na(G2theta))) %>%
  mutate(source = "GLODAP")
```

```{r Layer separation, eval = FALSE}

# A <- A %>%
#   mutate(layer = ifelse(G2pressure >= 100 & G2sigma0 <= 27.2, "NACW",
#                       ifelse(G2sigma0 > 27.2 & G2sigma1 <= 32.35,"MW",
#                              ifelse(G2sigma1 > 32.35 & G2sigma2 <= 37, "LSW",
#                                     ifelse(G2sigma2 > 37, "NADW", NA))))) %>%
#   filter(!is.na(layer))  # Delete the NA values in layer (surface points)
# 
# ord <- c("NACW", "MW", "LSW", "NADW")
# A$layer <- factor(A$layer, levels = ord)
```

```{r Carbon computations}

A <- A %>%  # Adding flags for seacarb
  mutate(flag = ifelse(G2talkf == 2 & G2tco2f == 2, 15,  # Flag 15 Alk & DIC
                     ifelse(G2talkf == 2 & G2tco2f == 0 & G2phtsinsitutpf == 2, 8,  # Flag 8 pH & Alk
                            ifelse(G2talkf == 0 & G2tco2f == 2 & G2phtsinsitutpf == 2, 9, NA))))  # Flag 9 pH & DIC
 
A <- bind_cols(A[, 1:ncol(A)-1],  # To delete the flag column
                     carb(flag = A$flag, 
                          var1 = ifelse(A$flag == 15, A$G2talk / 10^6, 
                                      ifelse(A$flag == 9, A$G2phtsinsitutp,
                                             ifelse(A$flag == 8, A$G2phtsinsitutp, NA))),
                          var2 = ifelse(A$flag == 15, A$G2tco2 / 10^6, 
                                      ifelse(A$flag == 9, A$G2tco2 / 10^6,
                                             ifelse(A$flag == 8, A$G2talk / 10^6, NA))),
                          A$G2salinity, 
                          A$G2theta, 
                          A$G2pressure / 10,  # Pressure in bar!
                          Patm = 1.0, 
                          Pt = A$G2phosphate / 10^6,  # Nutrients in mols/Kg
                          Sit = A$G2silicate / 10^6,
                          pHscale = "T", kf = "pf", k1k2 = "l", ks = "d", b = "u74"))

A <- mutate(A, xcCO3 = CO3 - (CO3 / OmegaAragonite))  # Compute xcCO3

A <- filter(A, !is.na(flag))
```

```{r Adding country & dates}

wtf = expocodes[expocodes$expocodeno %in% sort(unique(A$G2cruise)), ]
wtf <- rename(wtf, G2cruise = expocodeno)  # Rename to ease the future join
A <- full_join(A, wtf)
rm(wtf)  # Cleaning

# Adding country with https://vocab.ices.dk/ ICES codes (seen in Olsen 2016, GLODAP paper)
A$country = "Spain"
A$country[A$G2cruise %in% c(25, 58, 64)] = "Germany"
A$country[A$G2cruise %in% c(237)] = "USA"
A$country[A$G2cruise %in% c(368, 392, 393, 394, 395, 1047)] = "France"
A$country[A$G2cruise %in% c(673)] = "Poland"
A$country[A$G2cruise %in% c(679, 683, 693)] = "UK"

A$country = reorder(A$country, A$country, function(x)-length(x))

# Add dates in GLODAP
A <- mutate(A, date = lubridate::ymd(paste(A$G2year, A$G2month, A$G2day, sep = "/")))
```

```{r Various prelimanary plots}

  ggplot(A, aes(G2salinity, G2theta, color = as.character(round(G2sigma0, 1)))) +
    geom_point() +
    labs(color = "Sigma0") +
    xlab("Salinity") +
    ylab("Potential Temperature [Â°C]")

  ggplot(A, aes(x = country)) +
    geom_bar(aes(fill = country)) +
    scale_fill_brewer(type = "qual", palette = "Set1") +
    labs(x = "Country", y = "number of samples", 
         title = "Samples with carbon system in GLODAP near Portugal margin") +
    theme_minimal()
  
  ggplot(A, aes(x = G2year)) +
    geom_histogram(aes(fill = country), alpha = .5) +
    labs(x = "Year", y = "number of samples", 
         title = "Samples with carbon system in GLODAP near Portugal margin") +
    theme_minimal()
  
  A %>%
    filter(G2depth < 500) %>%
    ggplot(., aes(G2year, DIC * 10^6)) + 
    geom_point() + 
    geom_smooth(method = "lm")
  
  A %>%
    filter(G2depth < 500) %>%
    ggplot(., aes(G2year, pH)) + 
    geom_point() + 
    geom_smooth(method = "lm")
```

```{r Adding atmospheric data, eval = FALSE}

# Annual CO2 from Mauna Loa
# url <- 'ftp://ftp.cmdl.noaa.gov/ccg/co2/trends/co2_annmean_mlo.txt'
# file  <- tempfile()
# download.file(url, file)
# CO2ml <- read.table(file, header = F)
# CO2ml <- CO2ml %>%
#   rename(year = V1, ppm = V2, uncertainty = V3) %>%
#   mutate(site = "Mauna Loa") %>%
#   select(-uncertainty)
# 
# CO2 <- rename(CO2, G2year = year)  # To match the name in G2
# all <- left_join(extendedA, CO2, by = "G2year")
# 
# # Monthly CO2 (mCO2) from Mauna Loa
# url <- 'ftp://ftp.cmdl.noaa.gov/ccg/co2/trends/co2_mm_mlo.txt'
# file  <- tempfile()
# download.file(url, file)
# mCO2 <- read.table(file, header = F)
# mCO2 <- rename(mCO2, year = V1, month = V2, decimal_year = V3, ppm = V4, interpolated_ppm = V5, trend = V6, ndays = V7)
# 
# mCO2 <- mCO2 %>%
#   rename(G2year = year, G2month = month, mppm = ppm) %>%  # To match the name in G2
#   select(G2year, G2month, mppm)
# all <- left_join(all, mCO2, by = c("G2year", "G2month"))
# 
# # Monthly CO2 from the Azores
# https://www.esrl.noaa.gov/gmd/aftp/data/trace_gases/co2/flask/surface/co2_azr_surface-flask_1_ccgg_month.txt
```

# PM trends step 2 - Trend analysis pH
```{r CO2 data from OldPT and ICES after Neural Networks}

postNN_OldPT <- read_csv("postNN_CO2sys_OldPT.csv", na = "NaN")
postNN_OldPT <- postNN_OldPT %>% 
  mutate(source = "OldPT", country = "Portugal", xcCO3 = CO3out - (CO3out / OmegaARout))

postNN_ICES <- read_csv("postNN_CO2sys_ICESfiltered.csv", na = "NaN")
postNN_ICES <- postNN_ICES %>% 
  mutate(source = "ICES", country = "Portugal", xcCO3 = CO3out - (CO3out / OmegaARout))
```

```{r Computing mean pH with NN data}

only_pH_OldPT <- postNN_OldPT %>%  # A new data.frame from the loaded csv (and we keep it intact as postNN*)
  rename(G2year = year, pH = pHin) %>%  # Same name as in GLODAP
  filter(between(depth, 100, 500)) %>%  # To keep only the samples between 100 m and 500 m (both included)
  filter(pH > 7.9) %>%  # To delete some samples with very low pH (freshwater influence very likely)
  select(G2year, pH, source, country)  # Clean it all
  
# ICES data (The same for the ICES data)
only_pH_ICES <- postNN_ICES %>%
  rename(G2year = year, pH = pHin) %>%  # Same name as in GLODAP
  filter(between(PRESdb, 100, 500)) %>%  # To keep only the samples between 100 m and 500 m (both included)
  select(G2year, pH, source, country)   # Clean it all

# Again for the GLODAP data
only_pH_G2 <- A %>%
  filter(between(G2depth, 100, 500)) %>%
  select(G2year, pH, source, country)

# Joining the three data.farmes
dummy_pH <- full_join(only_pH_G2, only_pH_OldPT)
extended_pH <- full_join(dummy_pH, only_pH_ICES)  # 2-step join
rm(dummy_pH)

# Computing the mean pH per year
final_pH <- extended_pH %>%
  group_by(G2year) %>%
  summarise_at(vars(pH), mean, na.rm = TRUE)

# Computing the error of the mean ph per year
final_pH_error <- extended_pH %>%
  group_by(G2year) %>%
  summarise_at(vars(pH), sd, na.rm = TRUE)
```

```{r Linear model for pH}

RLMmodel_pH <- MASS::rlm(pH ~ G2year, data = final_pH, weights = (1 / final_pH_error$pH))

tableRLMmodel_pH <- summary(RLMmodel_pH)
trend_pH <- tableRLMmodel_pH[["coefficients"]][2, 1]  # This is the rate of change
etrend_pH <- tableRLMmodel_pH[["coefficients"]][2, 2]  # etrend stands for "error in the trend"

pvalue_pH <- pnorm(
  abs(
    broom::tidy(RLMmodel_pH)
    [2, "statistic", drop = TRUE]), lower.tail = FALSE) * 2
```

```{r Plot trend pH}

ggplot(final_pH, aes(G2year, pH)) +
  geom_jitter(data = extended_pH, aes(colour = source), alpha = .7, shape = 4, size = .3) +
  geom_smooth(method = MASS::rlm, color = "red", size = 2) +
  geom_point() +
  theme_minimal() +
  xlab("Year")
```

# PM trends step 3 - Trend analysis anthropogenic carbon
```{r Computing mean Cant per year}

Cant <- read.csv("Cant.csv")

only_Cant <- Cant %>% 
  filter(latitude >= (min(ABasin$lat)) & latitude <= (max(ABasin$lat))) %>%
  filter(longitude >= (min(ABasin$lon)) & longitude <= (max(ABasin$lon))) %>%
  mutate_all(.funs = funs(ifelse(. == "NaN", NA, .))) %>%
  filter(between(Depth, 100, 500)) %>%
  filter(!is.na(cAntPhiCt0ML)) %>%
  select(year, cAntPhiCt0ML)

final_Cant <- only_Cant %>%
  group_by(year) %>%
  summarise_at(vars(cAntPhiCt0ML), mean, na.rm = TRUE)

final_Cant_error <- only_Cant %>%
  group_by(year) %>%
  summarise_at(vars(cAntPhiCt0ML), sd, na.rm = TRUE)
```

```{r Linear model for Cant}

RLMmodel_Cant <- MASS::rlm(cAntPhiCt0ML ~ year, data = final_Cant, weights = (1 / final_Cant_error$cAntPhiCt0ML))

tableRLMmodel_Cant <- summary(RLMmodel_Cant)
trend_Cant <- tableRLMmodel_Cant[["coefficients"]][2, 1]  # This is the rate of change
etrend_Cant <- tableRLMmodel_Cant[["coefficients"]][2, 2]  # etrend stands for "error in the trend"

pvalue_Cant <- pnorm(
  abs(
    broom::tidy(RLMmodel_Cant)
    [2, "statistic", drop = TRUE]), lower.tail = FALSE) * 2
```

```{r Plot trend Cant}

ggplot(final_Cant, aes(year, cAntPhiCt0ML)) +
  geom_smooth(method = MASS::rlm, color = "red", size = 2) +
  geom_point() +
  theme_minimal() +
  xlab("Year") +
  ylab("Anthropogenic carbon [UNIT?]")
```

# PM trends step 4 - Trend analysis xcCO3
```{r Computing mean xcCO3 per year}

only_xcCO3_G2 <- A %>% 
  filter(between(G2depth, 100, 500)) %>%
  filter(!is.na(xcCO3)) %>%
  select(G2year, xcCO3, source, country)

only_xcCO3_OldPT <- postNN_OldPT %>% 
  rename(G2year = year) %>%  # Same name as in GLODAP
  filter(between(depth, 100, 500)) %>%
  filter(!is.na(xcCO3)) %>%
  select(G2year, xcCO3, source, country)

only_xcCO3_ICES <- postNN_ICES %>% 
  rename(G2year = year) %>%  # Same name as in GLODAP
  filter(between(PRESdb, 100, 500)) %>%
  filter(!is.na(xcCO3)) %>%
  select(G2year, xcCO3, source, country)

# Joining the three data.farmes
dummy_xcCO3 <- full_join(only_xcCO3_G2, only_xcCO3_OldPT)
extended_xcCO3 <- full_join(dummy_xcCO3, only_xcCO3_ICES)  # 2-step join
rm(dummy_xcCO3)

final_xcCO3 <- extended_xcCO3 %>%
  group_by(G2year) %>%
  summarise_at(vars(xcCO3), mean, na.rm = TRUE)

final_xcCO3_error <- extended_xcCO3 %>%
  group_by(G2year) %>%
  summarise_at(vars(xcCO3), sd, na.rm = TRUE)
```

```{r Linear model for xcCO3}

RLMmodel_xcCO3 <- MASS::rlm(xcCO3 ~ G2year, data = final_xcCO3, weights = (1 / final_xcCO3_error$xcCO3))

tableRLMmodel_xcCo3 <- summary(RLMmodel_xcCO3)
trend_xcCo3 <- tableRLMmodel_xcCo3[["coefficients"]][2, 1]  # This is the rate of change
etrend_xcCo3 <- tableRLMmodel_xcCo3[["coefficients"]][2, 2]  # etrend stands for "error in the trend"

pvalue_xcCO3 <- pnorm(
  abs(
    broom::tidy(RLMmodel_xcCO3)
    [2, "statistic", drop = TRUE]), lower.tail = FALSE) * 2
```

```{r Plot trend xcCO3}

ggplot(final_xcCO3, aes(G2year, xcCO3)) +
  geom_jitter(data = extended_xcCO3, aes(colour = source), alpha = .7, shape = 4, size = .3) +
  geom_smooth(method = MASS::rlm, color = "red", size = 2) +
  geom_point() +
  theme_minimal() +
  xlab("Year")
```